# Domain Zero - Security Scanning Example (GitHub Actions)
#
# This is a TEMPLATE workflow demonstrating security tool integration.
# Customize for your stack and enable by removing .example extension.
#
# IMPORTANT: Review and adjust tool configurations before enabling in production.

name: Security Scan (Example - Disabled)

# Uncomment to enable:
# on:
#   pull_request:
#     branches: [ main, develop ]
#   push:
#     branches: [ main ]
#   schedule:
#     - cron: '0 0 * * *'  # Daily at midnight

jobs:
  sast-scan:
    name: SAST - Static Code Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Example: Semgrep SAST
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto  # or: p/owasp-top-ten, p/security-audit

      # Example: Snyk Code SAST
      # - name: Run Snyk Code Test
      #   uses: snyk/actions/node@master
      #   with:
      #     command: code test
      #   env:
      #     SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  sca-scan:
    name: SCA - Dependency Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Example: Snyk Open Source SCA
      # - name: Run Snyk Dependency Test
      #   uses: snyk/actions/node@master
      #   with:
      #     command: test
      #   env:
      #     SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      # Example: OWASP Dependency-Check
      - name: Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'domain-zero-project'
          path: '.'
          format: 'HTML'

      - name: Upload Dependency-Check Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports/

  secrets-scan:
    name: Secrets Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      # Example: TruffleHog secrets detection
      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  container-scan:
    name: Container Image Scanning
    runs-on: ubuntu-latest
    # Only run if Dockerfile exists
    if: hashFiles('Dockerfile') != ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Example: Trivy container scanning
      - name: Run Trivy Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'your-image:tag'  # Replace with your image
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  iac-scan:
    name: IaC Security Scanning
    runs-on: ubuntu-latest
    # Only run if Terraform/K8s files exist
    if: hashFiles('**/*.tf', '**/*.yaml', '**/*.yml') != ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Example: Checkov IaC scanning
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: terraform,kubernetes
          output_format: cli
          soft_fail: true  # Don't fail build, just report

      # Example: tfsec for Terraform
      # - name: Run tfsec
      #   uses: aquasecurity/tfsec-action@v1.0.0
      #   with:
      #     soft_fail: true

  protocol-protection:
    name: Protocol File Protection Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need at least 2 commits for diff

      - name: Check for unauthorized protocol changes
        env:
          PROTOCOL_MAINTAINERS: ${{ secrets.PROTOCOL_MAINTAINERS }}
        run: |
          #!/bin/bash
          set -e

          # Check if we have enough history
          COMMIT_COUNT=$(git rev-list --count HEAD)

          if [ "$COMMIT_COUNT" -lt 2 ]; then
            echo "ℹ️  Skipping protocol check (first commit)"
            exit 0
          fi

          # Check if protocol files were modified
          CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null || git diff --name-only HEAD)

          if echo "$CHANGED_FILES" | grep -q "^protocol/CLAUDE.md"; then
            echo "⚠️  WARNING: CLAUDE.md was modified"

            # Check if actor is authorized (read from secret or use fallback)
            if [ -z "$PROTOCOL_MAINTAINERS" ]; then
              echo "⚠️  WARNING: PROTOCOL_MAINTAINERS secret not configured"
              echo "Using fallback authorization (replace in production)"
              AUTHORIZED_USERS=("repo-admin" "tech-lead")
            else
              IFS=',' read -ra AUTHORIZED_USERS <<< "$PROTOCOL_MAINTAINERS"
            fi

            ACTOR="${{ github.actor }}"
            IS_AUTHORIZED=false
            for USER in "${AUTHORIZED_USERS[@]}"; do
              if [ "$USER" = "$ACTOR" ]; then
                IS_AUTHORIZED=true
                break
              fi
            done

            if [ "$IS_AUTHORIZED" = false ]; then
              echo "❌ ERROR: Unauthorized modification of protocol/CLAUDE.md"
              echo "✓ Protocol changes require approval from authorized maintainers"
              exit 1
            fi

            echo "✓ Authorized user detected, proceeding"
          fi

# ============================================
# INTEGRATION WITH DOMAIN ZERO WORKFLOW
# ============================================
#
# After security scans complete:
# 1. Review scan results in GitHub Actions summary
# 2. Address critical/high findings before proceeding
# 3. Proceed with Domain Zero workflow:
#    - Yuuji implements → Tags @user-review
#    - User approves → Yuuji tags @security-review
#    - Megumi reviews:
#      * Checks scan results
#      * Conducts manual OWASP review
#      * Cross-references findings
#    - Tags @approved or @remediation-required
#
# ============================================
# CUSTOMIZATION NOTES
# ============================================
#
# 1. Enable workflows: Remove comments from 'on:' section (lines 11-17)
#    and rename file from .example.yml to .yml to activate
# 2. Add secrets: Configure in repository Settings → Secrets & variables:
#    - SNYK_TOKEN: Your Snyk API token for security scanning
#    - PROTOCOL_MAINTAINERS: Comma-separated GitHub usernames authorized
#      to edit protocol files (e.g., "user1,user2,user3")
# 3. Adjust tool configs: Match your tech stack (languages, frameworks, cloud platforms)
# 4. Configure notifications: Add Slack/email alerts for critical findings (optional)
# 5. Tune scan frequency: Adjust schedule cron for your needs (e.g., '0 0 * * 0' for weekly)
#
# For more examples, see:
# - Snyk: https://github.com/snyk/actions
# - Semgrep: https://github.com/returntocorp/semgrep-action
# - Trivy: https://github.com/aquasecurity/trivy-action
